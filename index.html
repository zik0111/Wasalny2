<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4F46E5">
    <meta name="description" content="Track your location and get notified when approaching destinations">

    <title>Travel Destination Tracker</title>

    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key="></script>

    <!-- CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Travel Destination Tracker</h1>
            <p>Get notified when approaching your destination</p>
        </div>

        <div class="permission-warning" id="permissionWarning">
            <strong>‚ö†Ô∏è Location Permission Required</strong>
            <p>Please enable location access to use this app.</p>
        </div>

        <div class="notification-badge" id="notificationBadge"></div>

        <div class="card">
            <h2 class="card-title">üó∫Ô∏è Select Destination</h2>

            <div id="map" style="height: 400px; border-radius: 12px;"></div>

            <div class="form-group">
                <label>Destination Coordinates</label>
                <div class="coord-input">
                    <input type="number" id="destLat" step="any" placeholder="Latitude">
                    <input type="number" id="destLng" step="any" placeholder="Longitude">
                </div>
                <p class="help-text">Click on the map to set destination</p>
            </div>

            <div class="form-group">
                <label for="radius">Notification Radius (meters)</label>
                <select id="radius">
                    <option value="100">100m (Very Close)</option>
                    <option value="500" selected>500m (Close)</option>
                    <option value="1000">1km (Nearby)</option>
                    <option value="2000">2km (Approaching)</option>
                    <option value="5000">5km (Far)</option>
                </select>
            </div>

            <div class="btn-grid">
                <button class="btn btn-primary" id="startBtn">
                    <span id="startBtnText">Start Tracking</span>
                </button>
                <button class="btn btn-danger" id="stopBtn">
                    Stop Tracking
                </button>
            </div>
        </div>

        <div class="status-card" id="statusCard" style="display:none;">
            <h3>üìä Tracking Status</h3>
            <div class="status-info">
                <div class="info-item">
                    <div class="info-label">Distance</div>
                    <div class="info-value" id="distanceValue">--</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Status</div>
                    <div class="info-value" id="statusValue">--</div>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <p><span class="footer-name">Abdalrahman</span></p>
            <p>¬© 2026 Travel Destination Tracker</p>
        </div>
    </footer>

    <!-- JS -->
    <script>
        const arrivalSound = new Audio('./alert.mp3');
        arrivalSound.preload = 'auto';
        arrivalSound.volume = 1.0;
        let audioUnlocked = false;

        if ('vibrate' in navigator) {
            navigator.vibrate([300, 150, 300]);
        }

        let map, destinationMarker, currentLocationMarker, trackingCircle;
        let watchId = null;
        let destination = null;
        let notificationRadius = 500;
        let hasNotified = false;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 30.0444, lng: 31.2357 },
                zoom: 13
            });

            map.addListener('click', (e) => {
                setDestination(e.latLng.lat(), e.latLng.lng());
            });

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(pos => {
                    updateCurrentLocation(pos.coords.latitude, pos.coords.longitude);
                    map.setCenter({ lat: pos.coords.latitude, lng: pos.coords.longitude });
                });
            }
        }

        function setDestination(lat, lng) {
            destination = { lat, lng };

            document.getElementById('destLat').value = lat.toFixed(6);
            document.getElementById('destLng').value = lng.toFixed(6);

            if (destinationMarker) destinationMarker.setMap(null);
            if (trackingCircle) trackingCircle.setMap(null);

            destinationMarker = new google.maps.Marker({
                position: { lat, lng },
                map: map
            });

            trackingCircle = new google.maps.Circle({
                strokeColor: "#1097b9",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#1097b9",
                fillOpacity: 0.2,
                map: map,
                center: { lat, lng },
                radius: notificationRadius
            });

            hasNotified = false;
        }

        function updateCurrentLocation(lat, lng) {
            if (!currentLocationMarker) {
                currentLocationMarker = new google.maps.Marker({
                    position: { lat, lng },
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 8,
                        fillColor: '#000',
                        fillOpacity: 1,
                        strokeWeight: 2
                    }
                });
            } else {
                currentLocationMarker.setPosition({ lat, lng });
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const œÜ1 = lat1 * Math.PI / 180;
            const œÜ2 = lat2 * Math.PI / 180;
            const ŒîœÜ = (lat2 - lat1) * Math.PI / 180;
            const ŒîŒª = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(ŒîœÜ / 2) ** 2 +
                      Math.cos(œÜ1) * Math.cos(œÜ2) *
                      Math.sin(ŒîŒª / 2) ** 2;

            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function startTracking() {
            if (!destination) {
                alert('Select a destination first');
                return;
            }

            if (!audioUnlocked) {
                arrivalSound.play()
                    .then(() => {
                        arrivalSound.pause();
                        arrivalSound.currentTime = 0;
                        audioUnlocked = true;
                        console.log('Audio unlocked');
                    })
                    .catch(err => console.warn('Audio unlock failed:', err));
            }

            watchId = navigator.geolocation.watchPosition(
                pos => {
                    const { latitude, longitude } = pos.coords;
                    updateCurrentLocation(latitude, longitude);

                    const distance = calculateDistance(
                        latitude, longitude,
                        destination.lat,
                        destination.lng
                    );

                    updateStatus(distance);
                },
                err => console.error(err),
                { enableHighAccuracy: true }
            );
        }

        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }

            arrivalSound.pause();
            arrivalSound.currentTime = 0;
            document.getElementById('statusCard').style.display = 'none';
            hasNotified = false;
        }

        function updateStatus(distance) {
            const card = document.getElementById('statusCard');
            card.style.display = 'block';

            document.getElementById('distanceValue').textContent =
                distance < 1000
                    ? `${Math.round(distance)}m`
                    : `${(distance / 1000).toFixed(2)}km`;

            if (distance <= notificationRadius) {
                card.classList.add('active');
                document.getElementById('statusValue').textContent = 'Arrived!';

                if (!hasNotified) {
                    hasNotified = true;
                    arrivalSound.currentTime = 0;
                    arrivalSound.play().catch(err => console.error('Sound failed:', err));

                    if (navigator.vibrate) {
                        navigator.vibrate([300, 150, 300]);
                    }

                    showNotification('ŸàÿµŸÑÿ™ ÿßŸÑŸÖŸÉÿßŸÜ');
                }
            } else {
                card.classList.remove('active');
                document.getElementById('statusValue').textContent = 'En Route';
            }
        }

        function showNotification(msg) {
            const badge = document.getElementById('notificationBadge');
            badge.textContent = msg;
            badge.classList.add('show');
            setTimeout(() => badge.classList.remove('show'), 4000);
        }

        document.getElementById('startBtn').onclick = startTracking;
        document.getElementById('stopBtn').onclick = stopTracking;
        document.getElementById('radius').onchange = e => {
            notificationRadius = +e.target.value;
            if (trackingCircle) trackingCircle.setRadius(notificationRadius);
        };

        window.onload = initMap;
    </script>
</body>
</html>

